;==============================================================================
;
; BACKGROUND
;
; Samuel Volk, July 2018
;
; Draw a background and scroll it around.
;
;==============================================================================
.GBHEADER
    NAME "BACKGROUND"
    CARTRIDGETYPE $00
    RAMSIZE $00
    COUNTRYCODE $01
    NINTENDOLOGO
    LICENSEECODENEW "SV"
    ROMDMG
.ENDGB


; Memory map
.MEMORYMAP
DEFAULTSLOT 0
SLOTSIZE $4000
SLOT 0 $0000
SLOT 1 $4000
.ENDME

; Cartridge details
.ROMBANKSIZE    $4000
.ROMBANKS       2
.CARTRIDGETYPE  0


;==============================================================================
; GAMEBOY HEADER
;==============================================================================
.BANK 0
.ORG $00    ; Reset $00
    jp $100
.ORG $08    ; Reset $08
    jp $100
.ORG $10    ; Reset $10
    jp $100
.ORG $18    ; Reset $18
    jp $100
.ORG $20    ; Reset $20
    jp $100
.ORG $28    ; Reset $28
    jp $100
.ORG $30    ; Reset $30
    jp $100
.ORG $38    ; Reset $38
    jp $100

.ORG $40    ; Vblank IRQ Vector
    reti
.ORG $48    ; LCD IRQ Vector
    reti
.ORG $50    ; Timer IRQ Vector
    reti
.ORG $58    ; Serial IRQ Vector
    reti
.ORG $60    ; Joypad IRQ Vector
    reti

.ORG $100   ; Code Execution Start
    nop
    jp Start
;.ORG $13F   ; Product code
;    .DB "    "
;.ORG $143   ; Color Gameboy compatibility code
;    .DB $01
;.ORG $144   ; Licence code
;    .DB $00,$00
;
;.ORG $146   ; Gameboy indicator
;    .DB $00 ; $00 - GameBoy
;.ORG $147   ; Cartridge type
;    .DB $00 ; $00 - ROM Only
;.ORG $148   ; ROM Size
;    .DB $00
;.ORG $149   ; RAM Size
;    .DB $00 ; $00 - None
;
;.ORG $14A   ; Destination code
;    .DB $01 ; $01 - non-japanese
;.ORG $14B
;    .DB $33 ; $33 - Check $0144/$0145 for Licensee code.


;==============================================================================
; SUBROUTINES
;==============================================================================
.BANK 0
.ORG $1000
.SECTION "Subroutines"

BlankSprites:
    ld hl, $8000
    ld bc, 4080
-   ld a, 0
    ldi (hl), a
    dec bc
    ld a, b
    or c
    jp nz, -
    ret

LoadTiles:
    ld hl, Iso1
    ld de, $8000
    ld bc, 32   ; 1 tile
-   ldi a, (hl)
    ld (de), a
    inc de
    dec bc
    ld a, b
    or c
    jp nz, -
    ret

LoadMap:
    ld hl, Map
    ld de, $9800
    ld bc, 1024
-   ldi a, (hl)
    ld (de), a
    inc de
    dec bc
    ld a, b
    or c
    jp nz, -
    ret

ScreenOn:
    ldh a, ($40)
    or %01000000
    ldh ($40), a
    ret

ScreenOff:
    ld a, 0
    ldh ($40), a
    ret

WaitVBlank:
    ld a, ($FF44)
    cp $91
    jr nz, WaitVBlank
    ret

.ENDS

;==============================================================================
; CODE
;==============================================================================

.ORG $150
Start:
    di              ; disable interrupts
    ld sp, $FFFE    ; setup stack

    ; wait for vblank
    call WaitVBlank
    ; turn screen off
    call ScreenOff

    ; clear bg tiles
    call BlankSprites
    ; load tiles
    call LoadTiles
    ; load map
    call LoadMap
    ; load BG palette
    ld a, %11100100
    ldh ($47), a

    ; turn on bg
    ; turn on screen
    ld a, %10010001
    ldh ($40), a
    ei


Loop:
    nop

    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank
    call WaitVBlank

    ; increment screen x
    ldh a, ($42)
    inc a
    ldh ($42), a
    ldh ($43), a
    
    jp Loop


;==============================================================================
; DATA
;==============================================================================
.SECTION "Path"
PathLen: .DB 10
PathX: .DB 0,1,2,3,4,5,4,3,2,1
PathY: .DB 0,1,2,3,4,5,4,3,2,1
.ENDS

.SECTION "Tiles"
Tiles:
Smile:
    .DB %01111110
    .DB %01111110
    .DB %11111111
    .DB %10000001
    .DB %11111111
    .DB %10100101
    .DB %11111111
    .DB %10100101
    .DB %11111111
    .DB %11000011
    .DB %11111111
    .DB %10111101
    .DB %11111111
    .DB %10000001
    .DB %01111110
    .DB %01111110

Brick:
    .DB %11111111, %00000011
    .DB %10000001, %00000011
    .DB %10111101, %00000011
    .DB %10111101, %00000011
    .DB %10111101, %00000011
    .DB %10111101, %00000011
    .DB %10000001, %11111111
    .DB %11111111, %11111111

Iso1:
    .DB %00000011, %00000011
    .DB %00001111, %00001100
    .DB %00111111, %00110000
    .DB %11111111, %11000000
    .DB %11111111, %11000000
    .DB %00111111, %00110000
    .DB %00001111, %00001100
    .DB %00000011, %00000011
Iso2:
    .DB %11000000, %11000000
    .DB %11110000, %00110000
    .DB %11111100, %00001100
    .DB %11111111, %00000011
    .DB %11111111, %00000011
    .DB %11111100, %00001100
    .DB %11110000, %00110000
    .DB %11000000, %11000000
Iso3:
    .DB %11111111, %00000011
    .DB %11111100, %00001100
    .DB %11110000, %00110000
    .DB %11000000, %11000000
    .DB %11000000, %11000000
    .DB %11110000, %00110000
    .DB %11111100, %00001100
    .DB %11111111, %00000011
Iso4:
    .DB %11111111, %11000000
    .DB %00111111, %00110000
    .DB %00001111, %00001100
    .DB %00000011, %00000011
    .DB %00000011, %00000011
    .DB %00001111, %00001100
    .DB %00111111, %00110000
    .DB %11111111, %11000000
.ENDS

.SECTION "Map"
.BLOCK "Map"
Map:
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.DB $00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01
.ENDB
.ENDS
